<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://www.springcloud.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://www.springcloud.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://www.springcloud.io/main.9f315399c0f37ff319ccd4f40971e41d0dfcc09c1b1bb649eaa98747dc2f68d3bfb6b943ada8a6d6e219696da36f93cf3b667dcc6b01c32c02bd77da51b3bf7c.css integrity="sha512-nzFTmcDzf/MZzNT0CXHkHQ38wJwbG7ZJ6qmHR9wvaNO/trlDraim1uIZaW2jb5PPO2Z9zGsBwywCvXfaUbO/fA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=keywords content="springcloud官方,springcloud中文文档,springcloud最新文档,springcloud中国"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Spring Cloud Kubernetes - SpringCloud中文社区</title><meta name=description content="Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。"><link rel=canonical href=https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="og:title" content="Spring Cloud Kubernetes"><meta property="og:description" content="Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。"><meta property="og:url" content="https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/"><meta property="og:site_name" content="SpringCloud中文社区"><meta property="article:published_time" content="2020-11-12T13:26:54+01:00"><meta property="article:modified_time" content="2020-11-12T13:26:54+01:00"><meta property="og:image" content="https://www.springcloud.io/doks.png"><meta property="og:image:alt" content="SpringCloud中文社区"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Spring Cloud Kubernetes"><meta name=twitter:description content="Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。"><meta name=twitter:image content="https://www.springcloud.io/doks.png"><meta name=twitter:image:alt content="Spring Cloud Kubernetes"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://www.springcloud.io/#/schema/organization/1","name":"Doks","url":"https://www.springcloud.io/","sameAs":["https://twitter.com/kevinblandy","https://github.com/KevinBlandy"],"logo":{"@type":"ImageObject","@id":"https://www.springcloud.io/#/schema/image/1","url":"https://www.springcloud.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://www.springcloud.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://www.springcloud.io/#/schema/website/1","url":"https://www.springcloud.io/","name":"SpringCloud中文社区","description":"SpringCloud中文社区专注于文档汉化，更新，以及行业前沿资讯的发布。","publisher":{"@id":"https://www.springcloud.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/","url":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/","name":"Spring Cloud Kubernetes","description":"Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。","isPartOf":{"@id":"https://www.springcloud.io/#/schema/website/1"},"about":{"@id":"https://www.springcloud.io/#/schema/organization/1"},"datePublished":"2020-11-12T13:26:54CET","dateModified":"2020-11-12T13:26:54CET","breadcrumb":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/"]}]},{"@type":"BreadcrumbList","@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://www.springcloud.io","url":"https://www.springcloud.io","name":"Home"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://www.springcloud.io/docs/","url":"https://www.springcloud.io/docs/","name":"Docs"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://www.springcloud.io/docs/springcloud/","url":"https://www.springcloud.io/docs/springcloud/","name":"Springcloud"}},{"@type":"ListItem","position":5,"item":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://www.springcloud.io/#/schema/article/1","headline":"Spring Cloud Kubernetes","description":"Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。","isPartOf":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/"},"mainEntityOfPage":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/"},"datePublished":"2020-11-12T13:26:54CET","dateModified":"2020-11-12T13:26:54CET","author":{"@id":"https://www.springcloud.io/#/schema/person/2"},"publisher":{"@id":"https://www.springcloud.io/#/schema/organization/1"},"image":{"@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://www.springcloud.io/#/schema/person/2","name":"kevinblandy","sameAs":["https://twitter.com/kevinblandy","https://github.com/KevinBlandy"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/#/schema/image/2","url":"https://www.springcloud.io/doks.png","contentUrl":"https://www.springcloud.io/doks.png","caption":"Spring Cloud Kubernetes"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://www.springcloud.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.springcloud.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.springcloud.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://www.springcloud.io/site.webmanifest><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?d725343fdb7604c5bd89b377295901df",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script></head><body class="docs single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://www.springcloud.io/>SpringCloud中文社区</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://www.springcloud.io/docs/>中文文档</a></li><li class=nav-item><a class=nav-link href=https://www.springcloud.io/blog/>行业资讯</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-SpringBoot aria-expanded=false>
SpringBoot</button></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-SpringCloud aria-expanded=true>
SpringCloud</button><div class="collapse show" id=section-SpringCloud><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-alibaba/>Spring Cloud Alibaba</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-bus/>Spring Cloud Bus</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-circuit-breaker/>Spring Cloud Circuit Breaker</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-config/>Spring Cloud Config</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-consul/>Spring Cloud Consul</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-gateway/>Spring Cloud Gateway</a></li><li><a class="docs-link rounded active" href=https://www.springcloud.io/docs/springcloud/spring-cloud-kubernetes/>Spring Cloud Kubernetes</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-netflix/>Spring Cloud Netflix</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-openfeign/>Spring Cloud OpenFeign</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-security-/>Spring Cloud Security</a></li><li><a class="docs-link rounded" href=https://www.springcloud.io/docs/springcloud/spring-cloud-sleuth/>Spring Cloud Sleuth</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#1-为什么需要spring-cloud-kubernetes>1. 为什么需要Spring Cloud Kubernetes？</a></li><li><a href=#2-starters>2. Starters</a><ul><li><a href=#21-服务发实>2.1. 服务发实</a></li><li><a href=#22-配置中心>2.2. 配置中心</a></li><li><a href=#23-所有spring-cloud-kubernetes功能>2.3. 所有Spring Cloud Kubernetes功能。</a></li></ul></li><li><a href=#3-用于kubernetes的discoveryclient>3. 用于Kubernetes的DiscoveryClient</a></li><li><a href=#4-kubernetes本地服务发现>4. Kubernetes本地服务发现</a></li><li><a href=#5-kubernetes-propertysource的实现>5. Kubernetes PropertySource的实现</a><ul><li><a href=#51-使用configmap-propertysource>5.1. 使用ConfigMap PropertySource</a></li><li><a href=#52-secrets-propertysource>5.2. Secrets PropertySource</a></li><li><a href=#53-propertysource-reload>5.3. PropertySource Reload</a></li></ul></li><li><a href=#6-kubernetes生态系统意识>6. Kubernetes生态系统意识</a><ul><li><a href=#61-kubernetes配置文件自动配置>6.1 Kubernetes配置文件自动配置</a></li><li><a href=#62-istio意识>6.2. Istio意识</a></li></ul></li><li><a href=#7-pod-健康指标>7. Pod 健康指标</a></li><li><a href=#8-信息贡献者>8. 信息贡献者</a></li><li><a href=#9-leader选举>9. Leader选举</a></li><li><a href=#10-用于kubernetes的负载均衡器>10. 用于Kubernetes的负载均衡器。</a></li><li><a href=#11-kubernetes内部的安全配置>11. Kubernetes内部的安全配置</a><ul><li><a href=#111-namespace>11.1. Namespace</a></li><li><a href=#112-服务账户>11.2. 服务账户</a></li></ul></li><li><a href=#12-服务注册的实施>12. 服务注册的实施</a></li><li><a href=#13-spring-cloud-kubernetes配置watcher>13. Spring Cloud Kubernetes配置Watcher</a><ul><li><a href=#131-deployment-yaml>13.1. Deployment YAML</a></li><li><a href=#132-监控-configmaps-和-secrets>13.2. 监控 ConfigMaps 和 Secrets</a></li><li><a href=#133-http的实现>13.3. HTTP的实现</a></li><li><a href=#134-messaging-implementation>13.4. Messaging Implementation</a></li><li><a href=#135-rabbitmq-配置>13.5. RabbitMQ 配置</a></li><li><a href=#136-kafka-配置>13.6. Kafka 配置</a></li></ul></li><li><a href=#14-examples>14. Examples</a></li><li><a href=#15-其他资源>15. 其他资源</a></li><li><a href=#16-配置属性>16. 配置属性</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://www.springcloud.io/>Home</a></li><li class=breadcrumb-item><a href=https://www.springcloud.io/docs/>Docs</a></li><li class=breadcrumb-item><a href=https://www.springcloud.io/docs/springcloud/>SpringCloud</a></li><li class="breadcrumb-item active" aria-current=page>Spring Cloud Kubernetes</li></ol></nav><h1>Spring Cloud Kubernetes</h1><p class=lead></p><ul><li>当前版本：2.0.3</li><li>修改时间：2021年7月24日</li><li>官方文档：<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/>https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/</a></li><li>源码仓库：<a href=https://github.com/spring-projects/spring-cloud>https://github.com/spring-projects/spring-cloud</a></li></ul><h2 id=1-为什么需要spring-cloud-kubernetes>1. 为什么需要Spring Cloud Kubernetes？<a href=#1-为什么需要spring-cloud-kubernetes class=anchor aria-hidden=true>#</a></h2><p>Spring Cloud Kubernetes提供了众所周知的Spring Cloud接口的实现，允许开发者在Kubernetes上构建和运行Spring Cloud应用。虽然这个项目在构建云原生应用时可能对你有用，但它也不是在Kubernetes上部署Spring Boot应用的必要条件。如果你刚刚开始在Kubernetes上运行你的Spring Boot应用，你只需要一个基本的Spring Boot应用和Kubernetes本身就可以完成很多事情。要想了解更多，你可以通过阅读<a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#cloud-deployment-kubernetes>Spring Boot部署到Kubernetes的参考文档</a>，以及通过研讨会材料<a href=https://hackmd.io/@ryanjbaxter/spring-on-k8s-workshop>Spring和Kubernetes</a>来开始。</p><h2 id=2-starters>2. Starters<a href=#2-starters class=anchor aria-hidden=true>#</a></h2><p>Starters是方便的依赖性描述符，你可以在你的应用程序中包含它。包括一个starter，以获得功能集的依赖性和Spring Boot自动配置。以<code>spring-cloud-starter-kubernetes-fabric8</code>开头的启动器提供了使用<a href=https://github.com/fabric8io/kubernetes-client>Fabric8 Kubernetes Java Client</a>的实现。以<code>spring-cloud-starter-kubernetes-client</code>开头的启动器提供了使用<a href=https://github.com/kubernetes-client/java>Kubernetes Java Client</a>的实现。</p><h3 id=21-服务发实>2.1. 服务发实<a href=#21-服务发实 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-fabric8<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>

<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-client<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p><a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#discoveryclient-for-kubernetes>Discovery Client</a>实现，将服务名称解析为Kubernetes服务。</p><h3 id=22-配置中心>2.2. 配置中心<a href=#22-配置中心 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-fabric8-config<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>

<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-client-config<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>从Kubernetes<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#configmap-propertysource>ConfigMaps</a>和<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#secrets-propertysource>Secrets</a>加载应用属性。当ConfigMap或Secret发生变化时，<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#propertysource-reload>重新加载</a>应用程序属性。</p><h3 id=23-所有spring-cloud-kubernetes功能>2.3. 所有Spring Cloud Kubernetes功能。<a href=#23-所有spring-cloud-kubernetes功能 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-fabric8-all<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-client-all<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><h2 id=3-用于kubernetes的discoveryclient>3. 用于Kubernetes的DiscoveryClient<a href=#3-用于kubernetes的discoveryclient class=anchor aria-hidden=true>#</a></h2><p>该项目为<a href=https://kubernetes.io/>Kubernetes</a>提供了<a href=https://github.com/spring-cloud/spring-cloud-commons/blob/master/spring-cloud-commons/src/main/java/org/springframework/cloud/client/discovery/DiscoveryClient.java>Discovery Client</a>的实现。这个客户端可以让你按名称查询Kubernetes端点（见<a href=https://kubernetes.io/docs/user-guide/services/>services</a>）。服务通常由Kubernetes API服务器公开，作为代表 <code>http</code> 和 <code>https</code> 地址的端点的集合，客户端可以从作为pod运行的Spring Boot应用程序中访问。</p><p>通过在你的项目中添加以下依赖关系，你可以免费获得这个东西。</p><p>Fabric8 Kubernetes Client</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-fabric8<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>Kubernetes Java Client</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>cloud</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>spring</span><span class=o>-</span><span class=n>cloud</span><span class=o>-</span><span class=n>starter</span><span class=o>-</span><span class=n>kubernetes</span><span class=o>-</span><span class=n>client</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span>
</code></pre></div><p>要启用<code>DiscoveryClient</code>的加载，请将<code>@EnableDiscoveryClient</code>添加到相应的配置或应用类中，如下例所示。</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@SpringBootApplication</span>
<span class=nd>@EnableDiscoveryClient</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Application</span> <span class=o>{</span>
  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Application</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>如下面的例子所示，你可以简单地通过自装配将客户端注入你的代码中。</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@Autowired</span>
<span class=kd>private</span> <span class=n>DiscoveryClient</span> <span class=n>discoveryClient</span><span class=o>;</span>
</code></pre></div><p>你可以通过在<code>application.properties</code>中设置以下属性来选择从所有命名空间启用<code>DiscoveryClient</code>。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.discovery.all-namespaces=true
</code></pre></div><p>要发现未被kubernetes api服务器标记为 &ldquo;ready&rdquo; 的服务端点地址，可以在<code>application.properties</code>中设置以下属性（默认：<code>false</code>）。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.discovery.include-not-ready-addresses=true
</code></pre></div><blockquote><p>这在为监控目的而发现服务时可能很有用，并能检查未准备好的服务实例的<code>/health</code>端点。</p></blockquote><p>如果你的服务暴露了多个端口，你将需要指定<code>DiscoveryClient</code>应该使用哪个端口。<code>DiscoveryClient</code>将使用以下逻辑选择端口。</p><ol><li>如果服务有一个标签<code>primary-port-name</code>，它将使用标签值中指定名称的端口。</li><li>如果没有标签，那么将使用<code>spring.cloud.kubernetes.discovery.primary-port-name</code>中指定的端口名称。</li><li>如果以上两者都没有指定，它将使用名为 <code>https</code> 的端口。</li><li>如果上述条件都不满足，它将使用名为 <code>http</code> 的端口。</li><li>作为最后手段，它将选择端口列表中的第一个端口。</li></ol><blockquote><p>最后一个选项可能会导致非确定性的行为。请确保对你的服务和/或应用程序进行相应的配置。</p></blockquote><p>默认情况下，所有的端口及其名称将被添加到<code>ServiceInstance</code>的元数据中。</p><p>如果出于任何原因，你需要禁用<code>DiscoveryClient</code>，你可以在<code>application.properties</code>中设置以下属性。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.discovery.enabled=false
</code></pre></div><p>一些Spring Cloud组件使用<code>DiscoveryClient</code>，以获取本地服务实例的信息。要做到这一点，你需要将Kubernetes服务名称与<code>spring.application.name</code>属性对齐。</p><blockquote><p><code>spring.application.name</code>对于在Kubernetes中为应用程序注册的名称没有影响。</p></blockquote><p>Spring Cloud Kubernetes还可以观察Kubernetes服务目录的变化，并相应地更新<code>DiscoveryClient</code>实现。为了启用这一功能，你需要在你的应用程序中的配置类上添加<code>@EnableScheduling</code>。</p><h2 id=4-kubernetes本地服务发现>4. Kubernetes本地服务发现<a href=#4-kubernetes本地服务发现 class=anchor aria-hidden=true>#</a></h2><p>Kubernetes本身能够进行（服务器端）服务发现（参见：<a href=https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services>kubernetes.io/docs/concepts/services-networking/service/#discovering-services</a>）。使用原生的kubernetes服务发现可以确保与其他工具的兼容性，例如Istio（<a href=https://istio.io/>istio.io</a>），一个能够实现负载均衡、断路器、故障转移等功能的服务网。</p><p>然后，调用者服务只需要引用特定Kubernetes集群中可解析的名称。一个简单的实现可以使用一个指向完全合格域名（FQDN）的spring <code>RestTemplate</code>，例如<code>{service-name}.{namespace}.svc.{cluster}.local:{service-port}</code>。</p><p>此外，你可以使用Hystrix进行熔断。</p><ul><li>通过在spring boot应用类中注解<code>@EnableCircuitBreaker</code>，在调用方实现熔断器。</li><li>Fallback 功能，通过用<code>@HystrixCommand(fallbackMethod=</code>) 注释相应的方法。</li></ul><h2 id=5-kubernetes-propertysource的实现>5. Kubernetes PropertySource的实现<a href=#5-kubernetes-propertysource的实现 class=anchor aria-hidden=true>#</a></h2><p>配置Spring Boot应用程序的最常见方法是创建<code>application.properties</code>或<code>application.yaml</code>或<code>application-profile.properties</code>或<code>application-profile.yaml</code>文件，其中包含为应用程序或Spring Boot启动器提供定制值的键值对。你可以通过指定系统属性或环境变量来覆盖这些属性。</p><h3 id=51-使用configmap-propertysource>5.1. 使用ConfigMap PropertySource<a href=#51-使用configmap-propertysource class=anchor aria-hidden=true>#</a></h3><p>Kubernetes提供了一个名为<a href=https://kubernetes.io/docs/user-guide/configmap/><code>ConfigMap</code></a>的资源，以键值对或嵌入的<code>application.properties</code>或<code>application.yaml</code>文件的形式将参数外化，传递给你的应用程序。<a href=https://github.com/spring-cloud/spring-cloud-kubernetes/tree/master/spring-cloud-kubernetes-fabric8-config>Spring Cloud Kubernetes Config</a>项目使Kubernetes的<code>ConfigMap</code>实例在应用启动过程中可用，并在发现观察到的<code>ConfigMap</code>实例发生变化时，触发Bean或Spring上下文的热重载。</p><p>默认行为是基于Kubernete的<code>ConfigMap</code>创建<code>Fabric8ConfigMapPropertySource</code>，其<code>metadata.name</code>值为Spring应用程序的名称（由其<code>spring.application.name</code>属性定义）或在<code>bootstrap.properties</code>文件中定义的自定义名称，键为：<code>spring.cloud.kubernetes.config.name</code>。</p><p>然而，更高级的配置是可能的，你可以使用多个<code>ConfigMap</code>实例。<code>spring.cloud.kubernetes.config.sources</code>列表使这成为可能。例如，你可以定义以下<code>ConfigMap</code>实例。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spring</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloud-k8s-app</span><span class=w>
</span><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-name</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default-namespace</span><span class=w>
</span><span class=w>        </span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a ConfigMap named c1 in namespace default-namespace</span><span class=w>
</span><span class=w>         </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>c1</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a ConfigMap named default-name in whatever namespace n2</span><span class=w>
</span><span class=w>         </span>- <span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>n2</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a ConfigMap named c3 in namespace n3</span><span class=w>
</span><span class=w>         </span>- <span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>n3</span><span class=w>
</span><span class=w>           </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>c3</span><span class=w>
</span></code></pre></div><p>在前面的例子中，如果没有设置<code>spring.cloud.kubernetes.config.namespace</code>，名为<code>c1</code>的<code>ConfigMap</code>将在应用程序运行的命名空间中被查找。</p><p>找到的任何匹配的<code>ConfigMap</code>将被处理如下。</p><ul><li>应用单个配置属性。</li><li>将任何名为<code>application.yaml</code>的属性内容作为<code>yaml</code>应用。</li><li>将任何名为<code>application.properties</code>的属性内容作为一个属性文件应用。</li></ul><p>上述流程的唯一例外是，当<code>ConfigMap</code>包含一个表明文件是YAML或属性文件的<strong>single</strong> key时。在这种情况下，键的名称不必是<code>application.yaml</code>或<code>application.properties</code>（它可以是任何东西），并且属性的值被正确处理。这一特点有助于通过使用类似以下内容来创建<code>ConfigMap</code>的用例。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl create configmap game-config --from-file<span class=o>=</span>/path/to/app-config.yaml
</code></pre></div><p>假设我们有一个名为<code>demo</code>的Spring Boot应用程序，它使用以下属性来读取其线程池配置。</p><ul><li>`pool.size.core</li><li><code>pool.size.maximum</code>。</li></ul><p>这可以外化为<code>yaml</code>格式的config map，如下。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>pool.size.core</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>pool.size.max</span><span class=p>:</span><span class=w> </span><span class=m>16</span><span class=w>
</span></code></pre></div><p>单独的属性在大多数情况下都能正常工作。然而，有时，嵌入<code>yaml</code>更方便。在这种情况下，我们使用一个名为<code>application.yaml</code>的单一属性来嵌入我们的<code>yaml</code>，如下所示。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    pool:
</span><span class=sd>      size:
</span><span class=sd>        core: 1
</span><span class=sd>        max:16</span><span class=w>    
</span></code></pre></div><p>下面的例子也可以。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>custom-name.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    pool:
</span><span class=sd>      size:
</span><span class=sd>        core: 1
</span><span class=sd>        max:16</span><span class=w>    
</span></code></pre></div><p>你也可以根据读取<code>ConfigMap</code>时合并在一起的活动配置文件，以不同方式配置Spring Boot应用程序。你可以通过使用<code>application.properties</code>或<code>application.yaml</code>属性，为不同的profile提供不同的属性值，指定特定的profile值，每个都在自己的文档中（用<code>---</code>序列表示），如下所示。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.yml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the World
</span><span class=sd>    farewell:
</span><span class=sd>      message: Say Goodbye
</span><span class=sd>    ---
</span><span class=sd>    spring:
</span><span class=sd>      profiles: development
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the Developers
</span><span class=sd>    farewell:
</span><span class=sd>      message: Say Goodbye to the Developers
</span><span class=sd>    ---
</span><span class=sd>    spring:
</span><span class=sd>      profiles: production
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the Ops</span><span class=w>    
</span></code></pre></div><p>在前面的案例中，通过开发配置文件加载到你的Spring应用程序的配置是这样的。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=nt>greeting</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Say Hello to the Developers</span><span class=w>
</span><span class=w>  </span><span class=nt>farewell</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Say Goodbye to the Developers</span><span class=w>
</span></code></pre></div><p>然而，如果<code>production</code>配置文件处于<code>active</code>状态，配置就会变成。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=nt>greeting</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Say Hello to the Ops</span><span class=w>
</span><span class=w>  </span><span class=nt>farewell</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Say Goodbye</span><span class=w>
</span></code></pre></div><p>如果两个配置文件都处于活动状态，在<code>ConfigMap</code>中最后出现的属性将覆盖前面的任何值。</p><p>另一个选择是为每个配置文件创建一个不同的配置map，spring boot会根据活动的配置文件自动获取它</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.yml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the World
</span><span class=sd>    farewell:
</span><span class=sd>      message: Say Goodbye</span><span class=w>    
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-development</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.yml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    spring:
</span><span class=sd>      profiles: development
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the Developers
</span><span class=sd>    farewell:
</span><span class=sd>      message: Say Goodbye to the Developers</span><span class=w>    
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-production</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.yml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    spring:
</span><span class=sd>      profiles: production
</span><span class=sd>    greeting:
</span><span class=sd>      message: Say Hello to the Ops
</span><span class=sd>    farewell:
</span><span class=sd>      message: Say Goodbye</span><span class=w>    
</span></code></pre></div><p>要告诉Spring Boot在启动时应该启用哪个配置文件，你可以通过<code>SPRING_PROFILES_ACTIVE</code>环境变量。要做到这一点，你可以用环境变量启动你的Spring Boot应用程序，你可以在容器规范的<code>PodSpec</code>中定义它。部署资源文件，如下所示。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deployment-name</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>deployment-name</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>deployment-name</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>deployment-name</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>container-name</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>your-image</span><span class=w>
</span><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPRING_PROFILES_ACTIVE</span><span class=w>
</span><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;development&#34;</span><span class=w>
</span></code></pre></div><blockquote><p>你应该检查安全配置部分。要从pod内部访问配置maps，你需要有正确的Kubernetes服务账户、角色和角色绑定。</p></blockquote><p>使用<code>ConfigMap</code>实例的另一个选择是通过运行Spring Cloud Kubernetes应用程序并让Spring Cloud Kubernetes从文件系统中读取它们，将它们挂载到Pod中。这种行为是由<code>spring.cloud.kubernetes.config.paths</code>属性控制的。你可以使用它来补充或替代前面描述的机制。你可以在<code>spring.cloud.kubernetes.config.paths</code>中使用<code>,</code>分隔符来指定多个（精确）文件路径。</p><blockquote><p>你必须提供每个属性文件的完整准确路径，因为目录没有被递归解析。</p></blockquote><blockquote><p>如果你使用<code>spring.cloud.kubernetes.config.paths</code>或<code>spring.cloud.kubernetes.secrets.path</code>，自动重载功能将不起作用。你将需要向<code>/actuator/refresh</code>端点发出<code>POST</code>请求，或者重新启动/重新部署应用程序。</p></blockquote><p>Table 1. Properties:</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>spring.cloud.kubernetes.config.enabled</code></td><td><code>Boolean</code></td><td><code>true</code></td><td>启用ConfigMaps <code>PropertySource</code>。</td></tr><tr><td><code>spring.cloud.kubernetes.config.name</code></td><td><code>String</code></td><td><code>${spring.application.name}</code></td><td>设置 <code>ConfigMap</code> 的名称以进行查询。</td></tr><tr><td><code>spring.cloud.kubernetes.config.namespace</code></td><td><code>String</code></td><td>Client namespace</td><td>设置查询的Kubernetes命名空间</td></tr><tr><td><code>spring.cloud.kubernetes.config.paths</code></td><td><code>List</code></td><td><code>null</code></td><td>设置 <code>ConfigMap</code> 实例的挂载路径。</td></tr><tr><td><code>spring.cloud.kubernetes.config.enableApi</code></td><td><code>Boolean</code></td><td><code>true</code></td><td>启用或禁用通过API消费<code>ConfigMap</code>实例的功能</td></tr></tbody></table><h3 id=52-secrets-propertysource>5.2. Secrets PropertySource<a href=#52-secrets-propertysource class=anchor aria-hidden=true>#</a></h3><p>Kubernetes有<a href=https://kubernetes.io/docs/concepts/configuration/secret/>Secrets</a>的概念，用于存储敏感数据，如密码、OAuth令牌等。这个项目提供了与 &ldquo;秘密 &ldquo;的集成，使秘密可以被Spring Boot应用程序访问。你可以通过设置<code>spring.cloud.kubernetes.secrets.enabled</code>属性明确地启用或禁用该功能。</p><p>启用后，<code>Fabric8SecretsPropertySource</code>从以下来源查找Kubernetes的<code>Secrets</code>。</p><ol><li>递归地从secrets挂载中读取</li><li>2.以应用程序命名（由<code>spring.application.name</code>定义）。</li><li>匹配一些标签</li></ol><p><strong>注意</strong></p><p>默认情况下，由于安全原因，通过API消费Secrets（上面第2和第3点）<strong>不启用</strong>。Secrets上的权限 &ldquo;list"允许客户端检查指定命名空间中的secrets值。此外，我们建议容器通过加载的卷来共享秘密。</p><p>如果你通过API启用消耗秘密，我们建议你通过使用授权策略来限制对秘密的访问，例如RBAC。关于通过API消费Secrets时的风险和最佳做法的更多信息，请参考<a href=https://kubernetes.io/docs/concepts/configuration/secret/#best-practices>本文档</a>。</p><p>如果发现了秘密，它们的数据就会被提供给应用程序。</p><p>假设我们有一个名为 <code>demo</code> 的spring boot应用程序，它使用属性来读取其数据库配置。我们可以通过使用以下命令创建一个Kubernetes secret。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl create secret generic db-secret --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>user --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span>p455w0rd
</code></pre></div><p>前面的命令将创建以下secret（你可以通过使用<code>kubectl get secrets db-secret -o yaml</code>查看）。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>cDQ1NXcwcmQ=</span><span class=w>
</span><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>dXNlcg==</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=ld>2017-07-04T09:15:57Z</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;357496&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>selfLink</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/namespaces/default/secrets/db-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>63c89263-6099-11e7-b3da-76d6186905a8</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></code></pre></div><p>注意，该数据包含由创建命令提供的字面意思的Base64编码版本。</p><p>然后，你的应用程序可以使用这个 <code>secret</code> - 例如，通过导出<code>secret</code>的值作为环境变量。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>${project.artifactId}</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>       </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>         </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_USERNAME</span><span class=w>
</span><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>                 </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span><span class=w>                   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span><span class=w>                   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASSWORD</span><span class=w>
</span><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>                 </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span><span class=w>                   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span><span class=w>                   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></code></pre></div><p>你可以通过多种方式选择要消费的<code>secret</code>。</p><ol><li><p>通过列出<code>secret</code>被映射的目录</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>-Dspring.cloud.kubernetes.secrets.paths<span class=o>=</span>/etc/secrets/db-secret,etc/secrets/postgresql
</code></pre></div><p>如果你把所有的<code>secret</code>都映射到一个共同的根上，你可以像这样设置它们。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>-Dspring.cloud.kubernetes.secrets.paths<span class=o>=</span>/etc/secrets
</code></pre></div></li><li><p>通过设置一个命名的<code>secret</code></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>-Dspring.cloud.kubernetes.secrets.name<span class=o>=</span>db-secret
</code></pre></div></li><li><p>通过定义一个标签列表</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>-Dspring.cloud.kubernetes.secrets.labels.broker<span class=o>=</span>activemq
-Dspring.cloud.kubernetes.secrets.labels.db<span class=o>=</span>postgresql
</code></pre></div></li></ol><p>如同 <code>ConfigMap</code> 的情况，更高级的配置也是可能的，你可以使用多个 <code>secret</code> 实例。<code>spring.cloud.kubernetes.secrets.sources</code>列表使这成为可能。例如，你可以定义以下<code>Secret</code>实例。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spring</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloud-k8s-app</span><span class=w>
</span><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>secrets</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-name</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default-namespace</span><span class=w>
</span><span class=w>        </span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a Secret named s1 in namespace default-namespace</span><span class=w>
</span><span class=w>         </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>s1</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a Secret named default-name in whatever namespace n2</span><span class=w>
</span><span class=w>         </span>- <span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>n2</span><span class=w>
</span><span class=w>         </span><span class=c># Spring Cloud Kubernetes looks up a Secret named s3 in namespace n3</span><span class=w>
</span><span class=w>         </span>- <span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>n3</span><span class=w>
</span><span class=w>           </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>s3</span><span class=w>
</span></code></pre></div><p>在前面的例子中，如果没有设置<code>spring.cloud.kubernetes.secrets.namespace</code>，命名为<code>s1</code>的<code>Secret</code>将在应用程序运行的命名空间中被查找到。</p><p>Table 2. Properties:</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>spring.cloud.kubernetes.secrets.enabled</code></td><td><code>Boolean</code></td><td><code>true</code></td><td>启用 Secrets <code>PropertySource</code></td></tr><tr><td><code>spring.cloud.kubernetes.secrets.name</code></td><td><code>String</code></td><td><code>${spring.application.name}</code></td><td>设置要查询的<code>Secrets</code>的名称</td></tr><tr><td><code>spring.cloud.kubernetes.secrets.namespace</code></td><td><code>String</code></td><td>Client namespace</td><td>设置Kubernetes的命名空间，用于查询</td></tr><tr><td><code>spring.cloud.kubernetes.secrets.labels</code></td><td><code>Map</code></td><td><code>null</code></td><td>设置用于查询<code>Secrets</code>的标签</td></tr><tr><td><code>spring.cloud.kubernetes.secrets.paths</code></td><td><code>List</code></td><td><code>null</code></td><td>设置安装<code>Secrets</code>的路径（例子1）。</td></tr><tr><td><code>spring.cloud.kubernetes.secrets.enableApi</code></td><td><code>Boolean</code></td><td><code>false</code></td><td>启用或禁用通过API消费<code>Secrets</code>的功能（例子2和3）。</td></tr></tbody></table><p><strong>注意事项</strong></p><ul><li><code>spring.cloud.kubernetes.secrets.labels</code>属性的行为与<a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding#map-based-binding>Map-based binding.</a>所定义的一致。</li><li><code>spring.cloud.kubernetes.secrets.paths</code>属性的行为与<a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding#collection-based-binding>Collection-based binding.</a>所定义的一样。</li><li>出于安全原因，通过API访问秘密可能受到限制。首选的方法是将秘密挂载到Pod上。</li></ul><p>你可以在<a href=https://github.com/fabric8-quickstarts/spring-boot-camel-config>spring-boot-camel-config</a>找到一个使用secrets的应用实例（尽管它还没有被更新到使用新的<code>spring-cloud-kubernetes</code>项目）。</p><h3 id=53-propertysource-reload>5.3. PropertySource Reload<a href=#53-propertysource-reload class=anchor aria-hidden=true>#</a></h3><blockquote><p>这一功能在2020.0版本中已被弃用。请参阅<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#spring-cloud-kubernetes-configuration-watcher>Spring Cloud Kubernetes Configuration Watcher</a>控制器，以获取实现相同功能的替代方法。</p></blockquote><p>一些应用程序可能需要检测外部属性源上的变化，并更新其内部状态以反映新的配置。Spring Cloud Kubernetes的重载功能能够在相关的<code>ConfigMap</code>或<code>Secret</code>发生变化时触发应用重载。</p><p>默认情况下，这个功能是禁用的。你可以通过使用<code>spring.cloud.kubernetes.reload.enabled=true</code>配置属性来启用它（例如，在<code>application.properties</code>文件中）。</p><p>支持以下级别的重载（通过设置<code>spring.cloud.kubernetes.reload.strategy</code>属性）。</p><ul><li><code>refresh</code>（默认）。只有用<code>@ConfigurationProperties</code>或<code>@RefreshScope</code>注释的配置豆被重新加载。这个重载级别利用了Spring Cloud Context的刷新功能。</li><li><code>restart_context</code>：整个Spring<code>ApplicationContext</code>被优雅地重新启动。豆类以新的配置重新创建。为了使重启上下文功能正常工作，你必须启用并公开重启执行器端点</li></ul><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>management</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>endpoint</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>exposure</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>restart</span><span class=w>
</span></code></pre></div><ul><li><code>shutdown</code>：Spring <code>ApplicationContext</code>被关闭以激活容器的重新启动。当你使用这个级别时，请确保所有非daemon线程的生命周期被绑定到ApplicationContext，并且复制控制器或复制集被配置为重启pod。</li></ul><p>假设在默认设置下启用了重载功能（刷新模式），当config map发生变化时，会刷新以下bean。</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@Configuration</span>
<span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;bean&#34;</span><span class=o>)</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyConfig</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=n>String</span> <span class=n>message</span> <span class=o>=</span> <span class=s>&#34;a message that can be changed live&#34;</span><span class=o>;</span>

    <span class=c1>// getter and setters
</span><span class=c1></span>
<span class=o>}</span>
</code></pre></div><p>为了看到变化的有效发生，你可以创建另一个Bean，定期打印消息，如下所示</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@Component</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyBean</span> <span class=o>{</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>MyConfig</span> <span class=n>config</span><span class=o>;</span>

    <span class=nd>@Scheduled</span><span class=o>(</span><span class=n>fixedDelay</span> <span class=o>=</span> <span class=n>5000</span><span class=o>)</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>hello</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;The message is: &#34;</span> <span class=o>+</span> <span class=n>config</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>你可以通过使用<code>ConfigMap</code>来改变应用程序打印的信息，如下所示。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reload-example</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>application.properties</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>    </span><span class=w>    </span><span class=l>bean.message=Hello World!</span><span class=w>
</span></code></pre></div><p>与pod相关的<code>ConfigMap'中名为</code>bean.message&rsquo;的属性的任何变化都会反映在输出中。更一般地说，与以<code>@ConfigurationProperties</code>注解的<code>prefix</code>字段定义的值为前缀的属性相关的变化会被检测并反映在应用程序中。本章前面解释了<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/#configmap-propertysource>将<code>ConfigMap</code>与pod相关联</a>。</p><p>完整的例子见<a href=https://github.com/spring-cloud/spring-cloud-kubernetes/tree/main/spring-cloud-kubernetes-examples/kubernetes-reload-example><code>spring-cloud-kubernetes-reload-example</code></a>。</p><p>重载功能支持两种操作模式:</p><ul><li><p><code>event</code>（默认）。通过使用Kubernetes API（网络套接字）来观察配置图或秘密的变化。任何事件都会产生对配置的重新检查，如果有变化，则重新加载。为了监听配置图的变化，需要服务账户上的<code>view</code>角色。秘密需要一个更高级别的角色（如<code>编辑</code>）（默认情况下，秘密不被监控）。</p></li><li><p><code>polling</code>。定期从配置图和秘密中重新创建配置，看它是否有变化。你可以通过使用<code>spring.cloud.kubernetes.reload.period</code>属性来配置轮询周期，默认为15秒。它要求与被监控的属性源的角色相同。这意味着，例如，在文件挂载的秘密源上使用轮询不需要特别的权限。</p></li></ul><p>Table 3. Properties:</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>spring.cloud.kubernetes.reload.enabled</code></td><td><code>Boolean</code></td><td><code>false</code></td><td>启用对配置资源的监控和配置重载</td></tr><tr><td><code>spring.cloud.kubernetes.reload.monitoring-config-maps</code></td><td><code>Boolean</code></td><td><code>true</code></td><td>允许监控 <code>config maps</code> 的变化</td></tr><tr><td><code>spring.cloud.kubernetes.reload.monitoring-secrets</code></td><td><code>Boolean</code></td><td><code>false</code></td><td>允许监控 <code>secrets</code>的变化</td></tr><tr><td><code>spring.cloud.kubernetes.reload.strategy</code></td><td><code>Enum</code></td><td><code>refresh</code></td><td>触发重载时使用的策略 ( <code>refresh</code> , <code>restart_context</code> , or <code>shutdown</code> )</td></tr><tr><td><code>spring.cloud.kubernetes.reload.mode</code></td><td><code>Enum</code></td><td><code>event</code></td><td>指定如何监听属性源的变化（<code>event</code>或<code>polling</code>）。</td></tr><tr><td><code>spring.cloud.kubernetes.reload.period</code></td><td><code>Duration</code></td><td><code>15s</code></td><td>使用 <code>polling</code> 策略时，验证变化的周期</td></tr></tbody></table><p><strong>注意事项</strong></p><ul><li>你不应该在<code>config maps</code>或<code>secrets</code>中使用<code>spring.cloud.kubernetes.reload</code>下的属性。在运行时改变这些属性可能会导致意外的结果。</li><li>当你使用<code>refresh</code>级别时，删除一个属性或整个配置图不会恢复bean的原始状态。</li></ul><h2 id=6-kubernetes生态系统意识>6. Kubernetes生态系统意识<a href=#6-kubernetes生态系统意识 class=anchor aria-hidden=true>#</a></h2><p>无论你的应用程序是否在Kubernetes内运行，本指南前面描述的所有功能都同样有效。这对开发和故障排除真的很有帮助。从开发的角度来看，这可以让你启动你的Spring Boot应用，并调试这个项目中的一个模块。你不需要在Kubernetes中部署它，因为项目的代码依赖于<a href=https://github.com/fabric8io/kubernetes-client>Fabric8 Kubernetes Java客户端</a>，它是一个流畅的DSL，可以通过使用<code>http</code>协议与Kubernetes服务器的REST API进行通信。</p><p>要禁用与Kubernetes的集成，你可以将<code>spring.cloud.kubernetes.enabled</code>设为<code>false</code>。请注意，当<code>spring-cloud-kubernetes-config</code>在classpath上时，<code>spring.cloud.kubernetes.enabled</code>应该设置在<code>bootstrap.{properties|yml}</code>（或特定的配置文件），否则应该在<code>application.{properties|yml}</code>（或特定的配置文件）。还要注意这些属性。<code>spring.cloud.kubernetes.config.enabled</code>和<code>spring.cloud.kubernetes.secrets.enabled</code>只有在<code>bootstrap.{properties|yml}</code>中设置才会生效。</p><h3 id=61-kubernetes配置文件自动配置>6.1 Kubernetes配置文件自动配置<a href=#61-kubernetes配置文件自动配置 class=anchor aria-hidden=true>#</a></h3><p>当应用程序在Kubernetes内以<code>pod</code>形式运行时，一个名为kubernetes的Spring配置文件会自动被激活。这让你可以定制配置，定义Spring Boot应用在Kubernetes平台上部署时应用的bean（例如，不同的开发和生产配置）。</p><h3 id=62-istio意识>6.2. Istio意识<a href=#62-istio意识 class=anchor aria-hidden=true>#</a></h3><p>当你在应用程序的classpath中包含<code>spring-cloud-kubernetes-fabric8-istio</code>模块时，一个新的配置文件被添加到应用程序中，前提是该应用程序在安装了<a href=https://istio.io/>Istio</a>的Kubernetes集群中运行。然后你可以在你的Bean和<code>@Configuration</code>类中使用spring <code>@Profile("istio")</code>注释。</p><p>Istio意识模块使用<code>me.snowdrop:istio-client</code>与Istio API交互，让我们发现流量规则、断路器等，使我们的Spring Boot应用程序能够轻松地消费这些数据，根据环境动态地配置自己。</p><h2 id=7-pod-健康指标>7. Pod 健康指标<a href=#7-pod-健康指标 class=anchor aria-hidden=true>#</a></h2><p>Spring Boot使用<a href=https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/health/HealthEndpoint.java><code>HealthIndicator</code></a>来暴露应用程序的健康信息。这使得它在向用户公开健康相关信息方面非常有用，并使它很适合作为<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/>准备就绪探针</a>使用。</p><p>Kubernetes健康指标（是核心模块的一部分）暴露了以下信息。</p><ul><li>Pod名称、IP地址、命名空间、服务账户、节点名称及其IP地址。</li><li>指示Spring Boot应用程序是在Kubernetes内部还是外部的一个标志。</li></ul><h2 id=8-信息贡献者>8. 信息贡献者<a href=#8-信息贡献者 class=anchor aria-hidden=true>#</a></h2><p>Spring Cloud Kubernetes包括一个<code>InfoContributor</code>，它将Pod信息添加到Spring Boot的<code>/info</code> Acturator 端点。</p><p>你可以通过在<code>bootstrap.[properties | yaml]</code>中设置<code>management.info.kubernetes.enabled</code>为<code>false</code>来禁用这个<code>InfoContributor</code>。</p><h2 id=9-leader选举>9. Leader选举<a href=#9-leader选举 class=anchor aria-hidden=true>#</a></h2><p>Spring Cloud Kubernetes领导者选举机制使用Kubernetes ConfigMap实现了Spring Integration的领导者选举API。</p><p>多个应用实例竞争领导权，但领导权只授予一个。当被授予领导权时，领导者应用会收到一个带有领导权<code>Context</code>的<code>OnGrantedEvent</code>应用事件。应用程序会定期尝试获得领导权，并将领导权授予第一个调用者。一个领导者将一直是一个领导者，直到它被从集群中移除，或者它放弃了它的领导权。当领导权被移除时，前一个领导者会收到<code>OnRevokedEvent</code>应用事件。移除后，集群中的任何实例都可以成为新的领导者，包括旧的领导者。</p><p>要在你的项目中包含它，请添加以下依赖关系。</p><p>Fabric8 Leader Implementation</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-kubernetes-fabric8-leader<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>要指定用于Leader选举的configmap的名称，请使用以下property。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.leader.config-map-name=leader
</code></pre></div><h2 id=10-用于kubernetes的负载均衡器>10. 用于Kubernetes的负载均衡器。<a href=#10-用于kubernetes的负载均衡器 class=anchor aria-hidden=true>#</a></h2><p>这个项目包括Spring Cloud Load Balancer，用于基于Kubernetes Endpoints的负载平衡，并提供了基于Kubernetes Service的负载平衡器的实现。要将其纳入你的项目，请添加以下依赖关系。</p><p>Fabric8 Implementation</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-fabric8-loadbalancer<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>Kubernetes Java Client Implementation</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-kubernetes-client-loadbalancer<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p>要启用基于Kubernetes服务名称的负载均衡，请使用以下属性。然后负载均衡器将尝试使用地址调用应用程序，例如<code>service-a.default.svc.cluster.local</code>。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.loadbalancer.mode=SERVICE
</code></pre></div><p>要启用所有命名空间的负载均衡，请使用以下属性。尊重<code>spring-cloud-kubernetes-discovery</code>模块的属性。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>spring.cloud.kubernetes.discovery.all-namespaces=true
</code></pre></div><h2 id=11-kubernetes内部的安全配置>11. Kubernetes内部的安全配置<a href=#11-kubernetes内部的安全配置 class=anchor aria-hidden=true>#</a></h2><h3 id=111-namespace>11.1. Namespace<a href=#111-namespace class=anchor aria-hidden=true>#</a></h3><p>本项目中提供的大多数组件都需要知道命名空间。对于Kubernetes（1.3以上），命名空间作为服务账户<code>secret</code>的一部分提供给pod，并由客户端自动检测。对于早期版本，它需要作为环境变量指定给pod。做到这一点的快速方法如下。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;KUBERNETES_NAMESPACE&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;metadata.namespace&#34;</span><span class=w>
</span></code></pre></div><h3 id=112-服务账户>11.2. 服务账户<a href=#112-服务账户 class=anchor aria-hidden=true>#</a></h3><p>或支持集群内更精细的基于角色的访问的Kubernetes发行版，你需要确保使用<code>spring-cloud-kubernetes</code>运行的pod可以访问Kubernetes API。对于你分配给部署或pod的任何服务账户，你需要确保他们有正确的角色。</p><p>根据要求，你需要在以下资源上有<code>get</code>、<code>list</code>和<code>watch</code>的权限。</p><p>Table 4. Kubernetes Resource Permissions</p><table><thead><tr><th>Dependency</th><th>Resources</th></tr></thead><tbody><tr><td>spring-cloud-starter-kubernetes-fabric8</td><td>pods, services, endpoints</td></tr><tr><td>spring-cloud-starter-kubernetes-fabric8-config</td><td>configmaps, secrets</td></tr><tr><td>spring-cloud-starter-kubernetes-client</td><td>pods, services, endpoints</td></tr><tr><td>spring-cloud-starter-kubernetes-client-config</td><td>configmaps, secrets</td></tr></tbody></table><p>为了开发的目的，你可以给你的 <code>default</code> 服务账户增加 <code>cluster-reader</code> 的权限。在生产系统中，你可能想提供更细的权限。</p><p>下面的Role和RoleBinding是一个为<code>default</code>账户命名的权限的例子。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>YOUR-NAME-SPACE</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>namespace-reader</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;extensions&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;pods&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;services&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;endpoints&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>namespace-reader-binding</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>YOUR-NAME-SPACE</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>namespace-reader</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></code></pre></div><h2 id=12-服务注册的实施>12. 服务注册的实施<a href=#12-服务注册的实施 class=anchor aria-hidden=true>#</a></h2><p>在Kubernetes中，服务注册由平台控制，应用程序本身并不像其他平台那样控制注册。因此，使用<code>spring.cloud.service-registry.auto-registration.enabled</code>或设置<code>@EnableDiscoveryClient(autoRegister=false)</code>在Spring Cloud Kubernetes中没有效果。</p><h2 id=13-spring-cloud-kubernetes配置watcher>13. Spring Cloud Kubernetes配置Watcher<a href=#13-spring-cloud-kubernetes配置watcher class=anchor aria-hidden=true>#</a></h2><p>Kubernetes提供了在应用程序的容器中<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#add-configmap-data-to-a-volume>将ConfigMap或Secret作为卷装载</a>的能力。当ConfigMap或Secret的内容发生变化时，<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically>挂载的卷就会根据这些变化进行更新</a>。</p><p>然而，除非你重新启动应用程序，否则Spring Boot不会自动更新这些变化。Spring Cloud提供了刷新应用程序上下文的能力，无需重启应用程序，方法是点击执行器端点<code>/refresh</code>或通过使用Spring Cloud Bus发布<code>RefreshRemoteApplicationEvent</code>。</p><p>为了实现在Kubernetes上运行的Spring Cloud应用程序的配置刷新，你可以将Spring Cloud Kubernetes配置观察者控制器部署到你的Kubernetes集群。</p><p>该应用以容器形式发布，可在<a href=https://hub.docker.com/repository/docker/springcloud/spring-cloud-kubernetes-configuration-watcher>Docker Hub</a>上使用。</p><p>Spring Cloud Kubernetes Configuration Watcher可以通过两种方式向应用程序发送刷新通知。</p><ol><li>通过HTTP，在这种情况下，被通知的应用程序必须有&rdquo;/refresh &ldquo;执行器端点暴露，并可从集群内访问。</li><li>2.使用Spring Cloud Bus，在这种情况下，你将需要一个部署在你的托管中心的消息代理，以便应用程序使用。</li></ol><h3 id=131-deployment-yaml>13.1. Deployment YAML<a href=#131-deployment-yaml class=anchor aria-hidden=true>#</a></h3><p>下面是一个部署YAML的样本，你可以用来将Kubernetes配置观察器部署到Kubernetes。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>List</span><span class=w>
</span><span class=w></span><span class=nt>items</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8888</span><span class=w>
</span><span class=w>          </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8888</span><span class=w>
</span><span class=w>      </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher:view</span><span class=w>
</span><span class=w>    </span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span><span class=w>      </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>namespace-reader</span><span class=w>
</span><span class=w>    </span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>namespace-reader</span><span class=w>
</span><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;extensions&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;pods&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;services&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;endpoints&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher-deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>spring-cloud-kubernetes-configuration-watcher</span><span class=w>
</span><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>springcloud/spring-cloud-kubernetes-configuration-watcher:2.0.1-SNAPSHOT</span><span class=w>
</span><span class=w>            </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>            </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8888</span><span class=w>
</span><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/actuator/health/readiness</span><span class=w>
</span><span class=w>            </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8888</span><span class=w>
</span><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/actuator/health/liveness</span><span class=w>
</span><span class=w>            </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8888</span><span class=w>
</span></code></pre></div><p>服务账户和相关的角色绑定对于Spring Cloud Kubernetes配置的正常工作非常重要。控制器需要读取Kubernetes集群中的ConfigMaps、Pod、服务、端点和Secrets数据的权限。</p><h3 id=132-监控-configmaps-和-secrets>13.2. 监控 ConfigMaps 和 Secrets<a href=#132-监控-configmaps-和-secrets class=anchor aria-hidden=true>#</a></h3><p>Spring Cloud Kubernetes Configuration Watcher将对标签为<code>spring.cloud.kubernetes.config</code>且值为<code>true</code>的ConfigMaps或标签为<code>spring.cloud.kubernetes.secret</code>且值为<code>true</code>的任何Secret中的变化做出反应。如果ConfigMap或Secret没有这些标签，或者这些标签的值不是<code>true</code>，那么任何改变都会被忽略。</p><p>Spring Cloud Kubernetes Configuration Watcher在ConfigMaps和Secrets上寻找的标签可以分别通过设置<code>spring.cloud.kubernetes.config.watcher.configLabel</code>和<code>spring.cloud.kubernetes.config.watcher.secretLabel</code>来改变。</p><p>如果对具有有效标签的ConfigMap或Secret进行了更改，那么Spring Cloud Kubernetes Configuration Watcher将采用ConfigMap或Secret的名称，并以该名称向应用程序发送通知。</p><h3 id=133-http的实现>13.3. HTTP的实现<a href=#133-http的实现 class=anchor aria-hidden=true>#</a></h3><p>HTTP实现是默认使用的。当使用该实现时，Spring Cloud Kubernetes Configuration Watcher和ConfigMap或Secret发生变化，那么HTTP实现将使用Spring Cloud Kubernetes Discovery Client来获取与ConfigMap或Secret名称匹配的所有应用程序实例，并向应用程序的actuator<code>/refresh</code>端点发送HTTP POST请求。默认情况下，它将使用发现客户端中注册的端口向<code>/actuator/refresh</code>发送post请求。</p><h4 id=1331-非默认的管理端口和执行器路径>13.3.1. 非默认的管理端口和执行器路径<a href=#1331-非默认的管理端口和执行器路径 class=anchor aria-hidden=true>#</a></h4><p>如果应用程序使用非默认的执行器路径和/或为管理端点使用不同的端口，应用程序的Kubernetes服务可以添加一个名为<code>boot.spring.io/actuator</code>的注解，并将其值设置为应用程序使用的路径和端口。例如</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>config-map-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-map-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>boot.spring.io/actuator</span><span class=p>:</span><span class=w> </span><span class=l>http://:9090/myactuator/home</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>config-map-demo</span><span class=w>
</span></code></pre></div><p>你可以选择配置执行器路径和/或管理端口的另一种方式是设置<code>spring.cloud.kubernetes.configuration.watcher.actuatorPath</code>和<code>spring.cloud.kubernetes.configuration.watcher.actuatorPort</code>。</p><h3 id=134-messaging-implementation>13.4. Messaging Implementation<a href=#134-messaging-implementation class=anchor aria-hidden=true>#</a></h3><p>当Spring Cloud Kubernetes配置观察者应用程序部署到Kubernetes时，可以通过将配置文件设置为<code>bus-amqp</code>（RabbitMQ）或<code>bus-kafka</code>（Kafka）来启用消息传递实现。</p><h3 id=135-rabbitmq-配置>13.5. RabbitMQ 配置<a href=#135-rabbitmq-配置 class=anchor aria-hidden=true>#</a></h3><p>当启用 <code>bus-amqp</code> 配置文件时，您将需要配置 Spring RabbitMQ 以将其指向您希望使用的 RabbitMQ 实例的位置，以及任何必要的验证凭证。这可以通过设置标准 Spring RabbitMQ 属性来完成，例如</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spring</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>rabbitmq</span><span class=w>
</span></code></pre></div><h3 id=136-kafka-配置>13.6. Kafka 配置<a href=#136-kafka-配置 class=anchor aria-hidden=true>#</a></h3><p>启用<code>bus-kafka</code>配置文件后，你需要配置Spring Kafka，将其指向你想使用的Kafka Broker实例的位置。这可以通过设置标准的Spring Kafka属性来完成，例如</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spring</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kafka</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>producer</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>bootstrap-servers</span><span class=p>:</span><span class=w> </span><span class=l>localhost:9092</span><span class=w>
</span></code></pre></div><h2 id=14-examples>14. Examples<a href=#14-examples class=anchor aria-hidden=true>#</a></h2><p>Spring Cloud Kubernetes试图通过遵循Spring Cloud的接口，使你的应用程序在消费Kubernetes原生服务时变得透明。</p><p>在你的应用程序中，你需要在classpath中添加<code>spring-cloud-kubernetes-discovery</code>依赖项，并删除任何包含<code>DiscoveryClient</code>实现（即Eureka发现客户端）的其他依赖项。这同样适用于 <code>PropertySourceLocator</code>，你需要在classpath中添加 <code>spring-cloud-kubernetes-config</code>，并删除任何包含 <code>PropertySourceLocator</code> 实现（即配置服务器客户端）的其他依赖。</p><p>以下项目强调了这些依赖关系的用法，并演示了你如何从任何Spring Boot应用程序中使用这些库。</p><ul><li><p><a href=https://github.com/sring-cloud/spring-cloud-kubernetes/tree/master/spring-cloud-kubernetes-examples>Spring Cloud Kubernetes Examples</a>：位于这个资源库里面的。</p></li><li><p>Spring Cloud Kubernetes完整示例。Minions和Boss</p><ul><li><a href=https://github.com/salaboy/spring-cloud-k8s-minion>Minion</a></li><li><a href=https://github.com/salaboy/spring-cloud-k8s-boss>Boss</a></li></ul></li><li><p>Spring Cloud Kubernetes完整示例：<a href=https://github.com/salaboy/s1p_docs>SpringOne Platform Tickets Service</a></p></li><li><p><a href=https://github.com/salaboy/s1p_gateway>Spring Cloud Gateway with Spring Cloud Kubernetes Discovery and Config</a></p></li><li><p><a href=https://github.com/salaboy/showcase-admin-tool>Spring Boot Admin with Spring Cloud Kubernetes Discovery and Config</a></p></li></ul><h2 id=15-其他资源>15. 其他资源<a href=#15-其他资源 class=anchor aria-hidden=true>#</a></h2><p>本节列出了其他资源，如关于Spring Cloud Kubernetes的演讲（slides）和视频。</p><ul><li><a href=https://salaboy.com/2018/09/27/the-s1p-experience/>S1P Spring Cloud on PKS</a></li><li><a href=https://salaboy.com/2018/07/18/ljc-july-18-spring-cloud-docker-k8s/>Spring Cloud, Docker, Kubernetes → London Java Community July 2018</a></li></ul><p>请随时通 pull requests 向<a href=https://github.com/spring-cloud/spring-cloud-kubernetes>本仓库</a>提交其他资源。</p><h2 id=16-配置属性>16. 配置属性<a href=#16-配置属性 class=anchor aria-hidden=true>#</a></h2><p>要查看所有与Kubernetes相关的配置属性列表，请查看<a href=https://docs.spring.io/spring-cloud-kubernetes/docs/current/reference/html/appendix.html>附录页面</a>。</p><div class=my-n3></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.netlify.com/>Netlify</a>, <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=https://www.springcloud.io/translation/>翻译计划</a></li><li class=list-inline-item><a href=https://www.springcloud.io/about/>关于</a></li></ul></div></div></div></footer><script src=https://www.springcloud.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://www.springcloud.io/js/highlight.min.21fbbff4ae23e5143eb2cab64edbdb48eb90be561eb53ee5766f2ef52ef0a1c917325706a2cdd769342b64b418c3b3030d8272769e72be6d3798fa05b0018c08.js integrity="sha512-Ifu/9K4j5RQ+ssq2TtvbSOuQvlYetT7ldm8u9S7wockXMlcGos3XaTQrZLQYw7MDDYJydp5yvm03mPoFsAGMCA==" crossorigin=anonymous defer></script><script src=https://www.springcloud.io/main.min.773144977fe359704aa8b57933ee2f435ba70c66684dfa06b01c50cf8131162bd2680301697f8d788259ff49ea7dc4d5f02683ad9ed0d53f22e99dddaeab1bab.js integrity="sha512-dzFEl3/jWXBKqLV5M+4vQ1unDGZoTfoGsBxQz4ExFivSaAMBaX+NeIJZ/0nqfcTV8CaDrZ7Q1T8i6Z3drqsbqw==" crossorigin=anonymous defer></script><script src=https://www.springcloud.io/index.min.35aca26ae731c3bcbf638f8e0145e805396fa959731d73c0dd870ca20a9488e92fe538953091569b2145766d020d6a3893436763ec0e517e032bfbd4bec8df6f.js integrity="sha512-Nayiaucxw7y/Y4+OAUXoBTlvqVlzHXPA3YcMogqUiOkv5TiVMJFWmyFFdm0CDWo4k0NnY+wOUX4DK/vUvsjfbw==" crossorigin=anonymous defer></script></body></html>